---
title: "Combine input data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Combine input data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

Now all the necessary input data is created, it is time to combine and reshape them so they can be used as input by SPAMc. The sections below briefly describe the main functions in mapspam2globiom to do this. Nearly all functions only require one input `param`, the object with the SPAMc parameters. Note that, although the functions might look simple as, 'under the hood' a lot of other functions are triggered, which automatically load the data that was created in previous steps, check them for consistency, reformat them from spatial to data table format and, where needed, run algorithms to harmonize the various inputs. This means that some of the functions might take some time to run, in particular if the resolution is set to 30 arcsec, which considerable increases the size of the model. All the functions send a message to the screen when they are processing and when they are finished so you know what is happening.  

All the intermediate data output is saved in the `processed_data/intermediate_output` folder. In case you have set `solve_level = 1`, the various functions split the data in administrative level 1 chunks, which are saved in subfolders using the administrative unit level 1 as name. If `solve_level = 0` there wil be only one subfolder that used the country iso3c code as name.
 

## Prepare cropland

The function `prepare_cropland()` combines the three synergy cropland components (medium and maximum cropland and cropland ranking maps) into a data table and stores this in a file. 

```{r eval = FALSE}
# Function to process the synergy cropland components.
prepare_cropland(param)
```

## Prepare irrigated area

`prepare_irrigated_area()` is similar to the function that prepares the cropland as it combines the synergy irrigated area maps (maximum irrigated area and ranking maps) into one file. 

```{r eval = FALSE}
prepare_irrigated_area(param)
```


## Prepare statistics

`prepare_physical_area()` combines the three agricultural statistics input files (harvested area, farming system shares and cropping intensity) to calculate the physical cropping area for all administrative units.

```{r}
prepare_physical_area(param)
```


## Harmonize inputs

Before the SPAMc can be run it is essential to harmonize the physical, cropland and irrigated area. As this data is coming from different sources, they will be never consistent. This would not be a problem if the cropland exent would be larger than the physical crop area, meaning there would be enough space to allocate the statistics on the cropland map. Similarly if the total irrigated area in the irrigated area map would be larger than the physical area of the irrigated farming systems the data would fit on the map. Unfortunately, often this does not happen, implying that SPAMc cannot be solved. In practice, we use 'slack variables' to ensure the model always solves (see [Appendix](appendix.html)). However, large slacks in the solution signal serious inconsistencies in the data and need to be corrected as much as possible.  

`harmonize_inputs()` uses a number of steps to harmonize the various data sources (also see the appendix in @Wood-Sichra2016):

- **Cropland - statistics harmonization.** As a starting point the available cropland is set to the medium cropland values from the synergy cropland map. For each individual subnational unit (if data is not missing) and starting with the most detailed level in the data, the total available (medium) cropland underlying the unit is compared with the physical area from the statistics that need to be allocated. If the statistics 'fit' no adjustments are made. If they do not not fit, the administrative unit cropland is expanded by switching to the maximum cropland value from the synergy cropland map. Subsequently, the cropland area and physical area are compared again and a warning is issued when there still is not enough cropland and the model will introduce slacks to make it solve. In a next iteration, the cropland and physical area of the units in the subsequent administrative level are harmonized taking into account the expansion of cropland in the previous iteration. This continues till cropland and physical area at the national level are compared and harmonized.

    In the end, the user has to decide if the slacks are acceptable or not. In our opinion small slacks (measured as share of total or administrative unit physical crop area) are no problem to deal with inconsistencies. However it slacks become very large we recommend scrutinizing your statistics and where possible make adjustments. Large slack often results from data entry errors or too rigid cropping intensity values. We provide some advise on how to deal with slack in the [Appendix](appendix.html). 

- **irrigated area - statistics harmonization/** In the next step, the irrigated area from the synergy irrigated area map and the irrigated physical area from the statistics are harmonized. We start by ranking all irrigated grid cells from the most (rank 1) to the least (rank 10) preferred. Next, for each grid cell, we set the irrigated area to the minimum of the cropland area (taken from the previous harmonization step) and the irrigated area from the synergy irrigated area map. The grid cells are subsequently aggregated till the total area is slightly larger than the irrigated physical area from the statistics. If the physical area turns out to be larger than the total irrigated cropland, meaning it does not fit, a new iteration is started in which the irrigated area per grid cell is increased by taking the maximum of the cropland area and the irrigated area. If this is still not sufficient, the irrigated area is further enlarged by taking the  maximum of the maximum cropland area and the irrigated area for each grid cell. It this is still not sufficient a warning is issued that solving the model will introduce slack. 

- **Select grid cells** In the final harmonization step the c


We used three global layers produced by SASAM: (1) a map with the median cropland per grid cell, (2) a map with the maximum cropland per grid cell, and (3) a map with the scores for each grid cell. To create the cropland extent for SPAMc we aggregated the maps to 30 arcsec and selected grid cells with the highest score from the median cropland map until the subnational and national the cumulative cropland area was close to the statistics. In case the accumulated cropland was not sufficient to allocate the statistics, the maximum cropland layer was used (for details about the procedure see @Wood-Sichra2016).


```{r eval = FALSE}
harmonize_inputs(param)
```


## Prepare scores and priors

```{r eval = FALSE}
prepare_score(param)
```


```{r eval = FALSE}
combine_inputs(param)
```


