---
title: "Post processing"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Post processing}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
resource_files:
  bib/mapspam.bib
bibliography: bib/mapspam.bib
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```


## Inspect results and create maps 

The package offers to functions to quickly inspect the results, after the model has been run. `view_panel()` shows crop distribution maps for a selected crop, using a different panel for each farming system. `view_stack()` shows the same information but stacking the various maps. Both functions plot the maps in the default browser overlaying the country polygon, unless specified otherwise. The visualization is done using [leafletjs](https://leafletjs.com/), which makes it possible to select different background tiles (e.g. OpenStreetMap) to put the data into perspective. 

```{r eval = FALSE}
view_panel("rice", var = "ha", param)
view_stack("rice", var = "ha", param)
```

As it is easier to process and visualize geo-spatial data when the data is saved in tif format, `create_all_tif()` produces a tif file for each crop - farming-system combination. The tif files are also needed as input to aggregate the data in a format that can be used by GLOBIOM, which is described next.

```{r eval = FALSE}
create_all_tif(param)
```


## Replacing land cover and land use information in GLOBIOM

With respect to the distribution of crops, GLOBIOM uses two related data layers. A table with area information on the land cover per simu, distinguishing six different land use classes:

- Total agricultural land (CrpLnd, OthAgri)
- Grassland (Grass)
- Forest (Forest)
- Wetlands (WetLnd)
- Other natural vegetation (OthNatLnd)
- Not relevant land cover (NotRel)

And a corresponding table with more detailed information on the crop area per simu. The land cover class **Total agricultural land** is divided into two parts: (1) Cropland (CrpLnd), which presents the location of the 20 crops that are modelled by GLOBIOM and (2) Other agricultural land, which presents the location of all the other crops. More information on the construction of the land cover and land use layers can be found in @Skalsky

The function `create_globiom_input()` creates two gdx files. One file updates the global land cover data in GLOBIOM for the target country, while the other file replaces global land use data. Both files will be saved in the `processed_data/results` folder. Before `create_globiom_input()` can be run, you need to prepare three input files.

First, you need to collect a new country level land cover map. Any product can be used as long as it contains information on the six GLOBIOM land cover classes. The most obvious choice would be to take a national land cover map for the year 2000 or any other map that is close to the year for which the subnational statistics are available. If such map is not available it is also possible to use a global land cover product and use the country polygon to mask the relevant area. We illustrate this case for Malawi, where we used the [ESACCI](https://www.esa-landcover-cci.org/2010) land cover map that was described in the section on [Input data collection](input_data_collection.html). We started by clipping the country area by running the script `03_spatial_data/select_esa.r` (see [Process spatial data](process_spatial_data.html). 

Second, we prepared a table (`mappings/esacci2globiom.csv`) that maps the ESACCI land cover classes to the six GLOBIOM land cover classes. This table will be used to aggregate the land cover classes in the new map to the GLOBIOM land cover classes. You will have to prepare a similar table for your land cover map. 

Finally, in case you want to add an additional crop, you have to update the table that maps the SPAMc crops to the 18 GLOBIOM crops (`mappings/crop2globiom.cvs`). In the example below, we will add coffee as a separate crop. The updated table will be loaded by `create_globiom_input()` to aggregate the SPAMc crops to the GLOBIOM crop classification.


```{r eval = FALSE}
# Select the new land cover map, in this case ESACCI
lc_file <- file.path(param$spam_path,
                              glue("processed_data/maps/cropland/{param$res}/esa_raw_{param$year}_{param$iso3c}.tif"))
# Load the map
lc_map <- raster(lc_file)
plot(lc_map)

# Update crop2globiom.csv and map coff to coff (instead of the rest category) and overwrite
load_data("crop2globiom", param)
crop2globiom <- crop2globiom %>%
  mutate(globiom_crop = ifelse(crop == "coff", "Coff", globiom_crop))
write_csv(crop2globiom, file.path(param$spam_path, "mappings/crop2globiom.csv"))

# Load mapping of lc classes to globiom lc classes
lc_class2globiom <- read_csv(file.path(param$spam_path, "mappings/esacci2globiom.csv"))

# Aggregate land cover map to GLOBIOM land cover classes at simu level
# Not that the area will be expressed in 1000 ha, which is common in GLOBIOM!
create_globiom_input(lc_class2globiom, lc_map, param)


create_globiom_input(param)
```

## Change GLOBIOM
